<div class="min-h-screen p-4 sm:p-8 flex justify-center animate-fade-in-scale transition-colors duration-300
            bg-gray-100 text-gray-800
            dark:bg-gray-900 dark:text-gray-100">
  <div class="w-full max-w-7xl space-y-8">

    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
      <h2 class="text-3xl font-bold mb-4 sm:mb-0 text-gray-900 dark:text-gray-100">
        Historial de Ventas y Recambios
      </h2>
      <button routerLink="/dashboard"
        class="group px-6 py-3 rounded-xl transition-all duration-300 font-medium text-sm shadow-lg hover:shadow-xl transform hover:-translate-y-1
               bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 text-gray-800
               dark:from-gray-700 dark:to-gray-800 dark:hover:from-gray-600 dark:hover:to-gray-700 dark:text-gray-100">
        <span class="flex items-center space-x-2">
          <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          <span>Volver al Panel</span>
        </span>
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      
      <div class="rounded-xl shadow-lg p-4 bg-white dark:bg-gray-800 transition-colors">
        <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-100">
          Filtrar por Tipo
        </h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <button (click)="filtrarTipo('todos')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="tipoFiltro() === 'todos'"
            [class.text-white]="tipoFiltro() === 'todos'"
            [ngClass]="tipoFiltro() !== 'todos' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
            Todos
          </button>
          <button (click)="filtrarTipo('ventas')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="tipoFiltro() === 'ventas'"
            [class.text-white]="tipoFiltro() === 'ventas'"
            [ngClass]="tipoFiltro() !== 'ventas' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
            Solo Ventas
          </button>
          <button (click)="filtrarTipo('recambios')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="tipoFiltro() === 'recambios'"
            [class.text-white]="tipoFiltro() === 'recambios'"
            [ngClass]="tipoFiltro() !== 'recambios' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
            Solo Recambios
          </button>
          <button (click)="filtrarTipo('ventasEliminadas')"
            class="px-2 py-2 rounded-lg font-medium transition-colors text-xs sm:text-sm"
            [class.bg-blue-600]="tipoFiltro() === 'ventasEliminadas'"
            [class.text-white]="tipoFiltro() === 'ventasEliminadas'"
            [ngClass]="tipoFiltro() !== 'ventasEliminadas' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
            Ventas Eliminadas
          </button>

<button (click)="filtrarFacturacion('todas')"
  class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
  [class.bg-blue-600]="filtroFacturacion() === 'todas'"
  [class.text-white]="filtroFacturacion() === 'todas'"
  [ngClass]="filtroFacturacion() !== 'todas' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
  Todas
</button>
          <button (click)="filtrarFacturacion('facturadas')"
      class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
      [class.bg-blue-600]="filtroFacturacion() === 'facturadas'"
      [class.text-white]="filtroFacturacion() === 'facturadas'"
      [ngClass]="filtroFacturacion() !== 'facturadas' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
      Facturadas
    </button>
    <button (click)="filtrarFacturacion('no_facturadas')"
      class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
      [class.bg-blue-600]="filtroFacturacion() === 'no_facturadas'"
      [class.text-white]="filtroFacturacion() === 'no_facturadas'"
      [ngClass]="filtroFacturacion() !== 'no_facturadas' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
      Sin Facturar
    </button>
        </div>
      </div>

      <div class="rounded-xl shadow-lg p-4 bg-white dark:bg-gray-800 transition-colors">
        <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-100">
          Filtrar por M√©todo de Pago
        </h3>
        <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-7 gap-2">
          <button (click)="filtrarMetodoPago('todos')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="metodoPagoFiltro() === 'todos'"
            [class.text-white]="metodoPagoFiltro() === 'todos'"
            [ngClass]="metodoPagoFiltro() !== 'todos' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
            Todos
          </button>
          
          <button (click)="filtrarMetodoPago('efectivo')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="metodoPagoFiltro() === 'efectivo'"
            [class.text-white]="metodoPagoFiltro() === 'efectivo'"
            [ngClass]="metodoPagoFiltro() !== 'efectivo' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
            üíµ Efectivo
          </button>
          
          <button (click)="filtrarMetodoPago('transferencia')"
            class="px-2 py-2 rounded-lg font-medium transition-colors text-xs sm:text-sm"
            [class.bg-blue-600]="metodoPagoFiltro() === 'transferencia'"
            [class.text-white]="metodoPagoFiltro() === 'transferencia'"
            [ngClass]="metodoPagoFiltro() !== 'transferencia' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
            üè¶ Transfer.
          </button>
          
          <button (click)="filtrarMetodoPago('debito')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="metodoPagoFiltro() === 'debito'"
            [class.text-white]="metodoPagoFiltro() === 'debito'"
            [ngClass]="metodoPagoFiltro() !== 'debito' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
            üí≥ D√©bito
          </button>
          
          <button (click)="filtrarMetodoPago('credito')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="metodoPagoFiltro() === 'credito'"
            [class.text-white]="metodoPagoFiltro() === 'credito'"
            [ngClass]="metodoPagoFiltro() !== 'credito' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
            üí≥ Cr√©dito
          </button>
          
          <button (click)="filtrarMetodoPago('mercado_pago')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="metodoPagoFiltro() === 'mercado_pago'"
            [class.text-white]="metodoPagoFiltro() === 'mercado_pago'"
            [ngClass]="metodoPagoFiltro() !== 'mercado_pago' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
            üì± MP
          </button>

          <button (click)="filtrarMetodoPago('fiado')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="metodoPagoFiltro() === 'fiado'"
            [class.text-white]="metodoPagoFiltro() === 'fiado'"
            [ngClass]="metodoPagoFiltro() !== 'fiado' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">
            üë§ Fiado
          </button>
        </div>
      </div>
      
      <div class="rounded-xl shadow-lg p-4 bg-white dark:bg-gray-800 transition-colors">
        <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-100">
          Filtrar por Per√≠odo
        </h3>
        <div class="grid grid-cols-2 lg:grid-cols-6 gap-3">
          <button (click)="filtrar('hoy')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="filtro() === 'hoy'"
            [class.text-white]="filtro() === 'hoy'"
            [ngClass]="filtro() !== 'hoy' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">Hoy</button>
          <button (click)="filtrar('7dias')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="filtro() === '7dias'"
            [class.text-white]="filtro() === '7dias'"
            [ngClass]="filtro() !== '7dias' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">7 d√≠as</button>
          <button (click)="filtrar('30dias')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="filtro() === '30dias'"
            [class.text-white]="filtro() === '30dias'"
            [ngClass]="filtro() !== '30dias' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">30 d√≠as</button>
          <button (click)="filtrar('todos')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="filtro() === 'todos'"
            [class.text-white]="filtro() === 'todos'"
            [ngClass]="filtro() !== 'todos' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">Todos</button>
          <button (click)="filtrar('fechaEspecifica')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="filtro() === 'fechaEspecifica'"
            [class.text-white]="filtro() === 'fechaEspecifica'"
            [ngClass]="filtro() !== 'fechaEspecifica' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">Fecha</button>
          <button (click)="filtrar('rangoFechas')"
            class="px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base"
            [class.bg-blue-600]="filtro() === 'rangoFechas'"
            [class.text-white]="filtro() === 'rangoFechas'"
            [ngClass]="filtro() !== 'rangoFechas' ? 'bg-gray-200 text-gray-800 hover:bg-blue-500 hover:text-white dark:bg-gray-700 dark:text-gray-300' : ''">Entre Fechas</button>
        </div>
      </div>

      <div class="rounded-xl shadow-lg p-4 bg-white dark:bg-gray-800 transition-colors">
        <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-100">
          Filtrar por Cliente, Email, ID o Usuario
        </h3>
        <input
          type="text"
          name="search_cliente_unique_id" 
          autocomplete="off"
          [ngModel]="busquedaCliente()"
          (ngModelChange)="busquedaCliente.set($event)"
          (input)="filtrarPorBusqueda()"
          placeholder="Cliente, email, ID de venta o usuario..."
          class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all
                 bg-white border-gray-300 text-gray-900 placeholder-gray-500
                 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"
        />
      </div>
    </div> 
    
    <div class="rounded-xl shadow-lg p-6 animate-fade-in bg-white dark:bg-gray-800 transition-colors" *ngIf="filtro() === 'fechaEspecifica'">
      <div class="flex flex-col sm:flex-row items-end gap-4">
        <div class="w-full sm:w-auto">
          <label for="fecha-especifica" class="font-medium mb-1.5 text-sm block opacity-80 text-gray-700 dark:text-gray-200">
            Selecciona la fecha:
          </label>
          <input
            type="date"
            id="fecha-especifica"
            class="rounded-xl p-2.5 w-full sm:w-auto border focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-sm font-medium
                   bg-gray-50 border-gray-300 text-gray-900
                   dark:bg-gray-700 dark:border-gray-600 dark:text-white"
            [ngModel]="fechaEspecifica()"
            (ngModelChange)="fechaEspecifica.set($event)"
          />
        </div>
        
        <button (click)="cargarDatos()" 
                [disabled]="!fechaEspecifica()"
                class="w-full sm:w-auto px-6 py-2.5 rounded-xl font-bold text-white transition-all shadow-md flex items-center justify-center gap-2"
                [ngClass]="fechaEspecifica() 
                  ? 'bg-blue-600 hover:bg-blue-700 hover:shadow-lg transform hover:-translate-y-0.5' 
                  : 'bg-gray-400 cursor-not-allowed'">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          Buscar
        </button>
      </div>
    </div>

    <div class="rounded-xl shadow-lg p-6 animate-fade-in bg-white dark:bg-gray-800 transition-colors" *ngIf="filtro() === 'rangoFechas'">
      <h3 class="font-medium mb-4 text-sm sm:text-base opacity-90 text-gray-700 dark:text-gray-200">
        Selecciona el rango de b√∫squeda:
      </h3>
      
      <div class="flex flex-col lg:flex-row gap-4 items-end">
        <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
          <div class="flex-1">
            <label class="block text-xs font-bold uppercase mb-1.5 opacity-70 text-gray-600 dark:text-gray-300">Desde</label>
            <input
              type="date"
              class="rounded-xl p-2.5 w-full border focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-sm font-medium
                     bg-gray-50 border-gray-300 text-gray-900
                     dark:bg-gray-700 dark:border-gray-600 dark:text-white"
              [ngModel]="fechaDesde()"
              (ngModelChange)="fechaDesde.set($event)"
            />
          </div>
          
          <div class="flex-1">
            <label class="block text-xs font-bold uppercase mb-1.5 opacity-70 text-gray-600 dark:text-gray-300">Hasta</label>
            <input
              type="date"
              class="rounded-xl p-2.5 w-full border focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-sm font-medium
                     bg-gray-50 border-gray-300 text-gray-900
                     dark:bg-gray-700 dark:border-gray-600 dark:text-white"
              [ngModel]="fechaHasta()"
              (ngModelChange)="fechaHasta.set($event)"
            />
          </div>
        </div>

        <button (click)="cargarDatos()"
                [disabled]="!fechaDesde() || !fechaHasta()"
                class="w-full lg:w-auto px-8 py-2.5 rounded-xl font-bold text-white transition-all shadow-md flex items-center justify-center gap-2"
                [ngClass]="(fechaDesde() && fechaHasta())
                  ? 'bg-blue-600 hover:bg-blue-700 hover:shadow-lg transform hover:-translate-y-0.5' 
                  : 'bg-gray-400 cursor-not-allowed'">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
          Aplicar Filtro
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div class="rounded-xl shadow-md p-4 flex items-center space-x-4 border-l-4 border-green-500 bg-white dark:bg-gray-800 transition-colors">
        <div class="bg-green-100 text-green-700 p-3 rounded-full flex-shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8a1 1 0 100-2 1 1 0 000 2zm0 4a1 1 0 100-2 1 1 0 000 2zm0 4a1 1 0 100-2 1 1 0 000 2z" />
          </svg>
        </div>
        <div>
          <p class="font-medium text-sm text-gray-500 dark:text-gray-300">
            Total Ventas
          </p>
          
          <div *ngIf="cargandoTotales()" class="h-8 flex items-center">
             <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-green-600"></div>
          </div>
          <p *ngIf="!cargandoTotales()" class="text-green-600 font-bold text-2xl animate-fade-in">
            {{ totalVentas() | monedaArs }}
          </p>
        </div>
      </div>

      <div class="rounded-xl shadow-md p-4 flex items-center space-x-4 border-l-4 border-orange-500 bg-white dark:bg-gray-800 transition-colors">
        <div class="bg-orange-100 text-orange-700 p-3 rounded-full flex-shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h8m-4-4v12m-4-8h8m-4-4v12m-4-8h8m-4-4v12M3 13h18M3 17h18" />
          </svg>
        </div>
        <div>
          <p class="font-medium text-sm text-gray-500 dark:text-gray-300">
            Total Recambios
          </p>
          
          <div *ngIf="cargandoTotales()" class="h-8 flex items-center">
             <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-orange-600"></div>
          </div>
          <p *ngIf="!cargandoTotales()" class="text-orange-600 font-bold text-2xl animate-fade-in">
            {{ totalRecambios() | monedaArs }}
          </p>
        </div>
      </div>
    </div>

    <div class="flex items-center justify-center gap-2 overflow-x-auto py-4">
      <button
        class="px-3 py-1 rounded-full text-sm font-medium transition hover:bg-gray-300"
        [ngClass]="themeService.theme() === 'dark' 
          ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
          : 'bg-gray-200 text-gray-800 hover:bg-gray-300'"
        [disabled]="paginaActual() === 1"
        (click)="cambiarPagina(paginaActual() - 1)">
        ‚Üê Anterior
      </button>

      <ng-container *ngFor="let p of [].constructor(totalPaginas() || 0); let i = index">
        <button
          (click)="cambiarPagina(i + 1)"
          [class.bg-blue-600]="paginaActual() === i + 1"
          [class.text-white]="paginaActual() === i + 1"
          class="w-8 h-8 rounded-full font-medium hover:bg-blue-500 hover:text-white transition text-sm"
          [ngClass]="paginaActual() !== i + 1 ? (themeService.theme() === 'dark' 
            ? 'bg-gray-700 text-gray-300'
            : 'bg-gray-200 text-gray-800') : ''">
          {{ i + 1 }}
        </button>
      </ng-container>

      <button
        class="px-3 py-1 rounded-full text-sm font-medium transition"
        [ngClass]="themeService.theme() === 'dark' 
          ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
          : 'bg-gray-200 text-gray-800 hover:bg-gray-300'"
        [disabled]="paginaActual() === totalPaginas()"
        (click)="cambiarPagina(paginaActual() + 1)">
        Siguiente ‚Üí
      </button>
    </div>

    <div *ngIf="cargando()" class="flex flex-col justify-center items-center py-12 animate-fade-in">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 mb-4"
             [ngClass]="themeService.theme() === 'dark' ? 'border-blue-400' : 'border-blue-600'"></div>
        <p class="animate-pulse font-medium"
           [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-600'">
           Cargando historial...
        </p>
    </div>

    <div *ngIf="!cargando()" 
     class="space-y-6  max-h-[800px] overflow-y-auto pr-2 custom-scrollbar"
     (scroll)="onScroll($event)">
        
        <div *ngFor="let item of items(); trackBy: trackByFn" 
             class="rounded-xl shadow-lg transition-all duration-300 cursor-pointer"
             [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-800 hover:bg-gray-750' : 'bg-white hover:bg-gray-50'"
             (click)="toggleCard(item.id)">
  
            <div class="p-6">
                <div *ngIf="item.tipo === 'venta' || item.tipo === 'ventaEliminada'" 
                     [class.opacity-50]="item.tipo === 'ventaEliminada'"
                     [class.bg-gray-100]="item.tipo === 'ventaEliminada' && themeService.theme() === 'light'"
                     [class.bg-gray-900]="item.tipo === 'ventaEliminada' && themeService.theme() === 'dark'"
                     [class.bg-white]="item.tipo === 'venta' && themeService.theme() === 'light'"
                     [class.bg-gray-800]="item.tipo === 'venta' && themeService.theme() === 'dark'">
  
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold"
                                  [class.bg-green-100]="item.tipo === 'venta'"
                                  [class.text-green-800]="item.tipo === 'venta'"
                                  [class.bg-red-100]="item.tipo === 'ventaEliminada'"
                                  [class.text-red-800]="item.tipo === 'ventaEliminada'">
                                <span *ngIf="item.tipo === 'venta'">VENTA</span>
                                <span *ngIf="item.tipo === 'ventaEliminada'">VENTA ELIMINADA</span>
                            </span>
                            <div *ngIf="item.recambio_realizado && item.tipo === 'venta'" class="inline-block bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-semibold">
                                ‚úÖ Recambio realizado
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm"
                                  [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-500'">
                                ID: {{ item.id.slice(-8) || 'N/A' }}
                            </span>
                            <svg class="w-5 h-5 transition-transform duration-300"
                                 [class.rotate-180]="isCardExpandido(item.id)"
                                 [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-500'"
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
  
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-1 mb-2 text-sm">
                        <p class="font-medium"
                           [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-700'">
                            <strong>Cliente:</strong> {{ item.cliente_nombre || 'Sin cliente' }}
                        </p>
                        <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-600'">
                            <strong>Fecha:</strong> {{ item.fecha | date: 'dd/MM/yyyy HH:mm' }}
                        </p>
                    </div>
  
                    <p class="text-xl font-bold"
                       [class.text-green-600]="item.tipo === 'venta'"
                       [class.text-gray-500]="item.tipo === 'ventaEliminada'">
                        Total: {{ (item.total_final || 0) | monedaArs }}
                    </p>
  
                    <div *ngIf="isCardExpandido(item.id)" 
                         class="mt-4 pt-4 border-t animate-fade-in"
                         [ngClass]="themeService.theme() === 'dark' ? 'border-gray-700' : 'border-gray-200'"
                         (click)="$event.stopPropagation()">
                        
                        <div *ngIf="item.tipo === 'ventaEliminada'" class="bg-red-50 border-l-4 border-red-400 p-3 mb-4 rounded-r-lg">
                            <p class="text-sm text-red-700">
                                <strong>Eliminado por:</strong> {{ item.eliminado_por || 'Usuario desconocido' }} 
                                <span class="ml-2 text-xs text-red-600">
                                    ({{ item.fecha_eliminacion | date: 'dd/MM/yyyy HH:mm' }})
                                </span>
                            </p>
                            <p class="text-sm text-red-700 mt-1">
                                <strong>ID Venta Original:</strong> {{ item.venta_id?.slice(-8) || 'N/A' }}
                            </p>
                            <p class="text-xs text-red-600 mt-1">{{ item.motivo_eliminacion || 'Sin motivo especificado' }}</p>
                        </div>
  
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-1 mb-4 text-sm">
                            <p class="font-medium"
                               [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-700'">
                                <strong>Usuario:</strong> {{ item.nombre_usuario || 'Sin usuario' }}
                            </p>
                            <p *ngIf="item.cliente_email"
                               [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-600'">
                                <strong>Email:</strong> {{ item.cliente_email }}
                            </p>
                        </div>
  
                        <div class="mt-4 pt-4"
                             [ngClass]="themeService.theme() === 'dark' ? 'border-gray-700' : 'border-gray-200'"
                             style="border-top-width: 1px;">
                            <p class="font-semibold mb-2 text-sm sm:text-base"
                               [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-800'">
                                Productos vendidos:
                            </p>
                            <ul class="list-disc ml-5 space-y-1 text-sm">
                                <li *ngFor="let p of item.productos || []; trackBy: trackByProductoId"
                                    [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-700'">
                                    {{ p.nombre }} ‚Äî 
                                    <span class="font-medium">Marca: {{ p.marca || 'N/A' }}</span> ‚Äî 
                                    Talle: {{ p.talle || 'N/A' }} ‚Äî 
                                    Cant: {{ p.cantidad }} ‚Äî 
                                    {{ (p.precio_unitario || 0) | monedaArs }} c/u ‚Äî 
                                    Subtotal: <span class="font-medium">{{ (p.subtotal || 0) | monedaArs }}</span>
                                </li>
                            </ul>
                        </div>
  
                        <div class="mt-4 pt-4"
                             [ngClass]="themeService.theme() === 'dark' ? 'border-gray-700' : 'border-gray-200'"
                             style="border-top-width: 1px;">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-2">
                                <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-800'">
                                    <strong>M√©todo de pago: </strong> 
                                    <span *ngIf="!esPagoMixto(item.metodo_pago || '')" class="font-medium">
                                        {{ item.metodo_pago === 'modo' ? 'Mercado Pago' : item.metodo_pago || 'No especificado' }}
                                    </span>
                                    <span *ngIf="esPagoMixto(item.metodo_pago || '')" class="block mt-1">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium mr-1"
                                              [ngClass]="themeService.theme() === 'dark' ? 'bg-blue-900/30 text-blue-300' : 'bg-blue-100 text-blue-800'">
                                            Pago Mixto
                                        </span>
                                        <span class="block text-sm mt-1" [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-600'">
                                            {{ normalizarMetodoPagoParaMostrar(item.metodo_pago || '') }}
                                        </span>
                                    </span>
                                </p>
                                <p *ngIf="(item.descuento_aplicado || 0) > 0"
                                   [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-800'">
                                    <strong>Descuento: </strong> <span class="text-red-600 font-medium">{{ item.descuento_aplicado || 0 }}%</span>
                                    <span class="text-sm ml-2"
                                          [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-500'">
                                    ({{ (((item.total_final || 0) / (1 - (item.descuento_aplicado || 0) / 100)) - (item.total_final || 0)) | monedaArs }} de ahorro)
                                    </span>
                                </p>
                            </div>
                        </div>
  
                        <div *ngIf="item.tipo === 'venta'" class="mt-6 flex justify-between">
                            <button *appPermiso="['historial', 'crear']"
                                    (click)="iniciarRecambio(item); $event.stopPropagation()"
                                    [disabled]="!puedeRealizarRecambio(item)"
                                    class="px-5 py-2 rounded-full font-medium transition-all"
                                    [class.bg-blue-600]="puedeRealizarRecambio(item)"
                                    [class.hover:bg-blue-700]="puedeRealizarRecambio(item)"
                                    [class.text-white]="puedeRealizarRecambio(item)"
                                    [ngClass]="!puedeRealizarRecambio(item) ? (themeService.theme() === 'dark' ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-500') : ''">
                                <span *ngIf="puedeRealizarRecambio(item)">Realizar Recambio</span>
                                <span *ngIf="!puedeRealizarRecambio(item) && item.recambio_realizado">Recambio ya realizado</span>
                                <span *ngIf="!puedeRealizarRecambio(item) && !item.recambio_realizado">Fuera de plazo (>10 d√≠as)</span>
                            </button>
                            
                            <button *appPermiso="['historial', 'eliminar']"
                                    (click)="iniciarEliminacionVenta(item); $event.stopPropagation()"
                                    [disabled]="item.recambio_realizado"
                                    class="group/btn inline-flex items-center justify-center w-8 h-8 sm:w-auto sm:h-auto sm:px-3 sm:py-1.5 text-sm rounded-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-1"
                                    [ngClass]="{
                                        'bg-red-50 text-red-600 hover:bg-red-100 focus:ring-red-500 border border-red-200 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30 dark:border-red-800': !item.recambio_realizado,
                                        'bg-gray-50 text-gray-400 cursor-not-allowed border border-gray-200 dark:bg-gray-800 dark:text-gray-600 dark:border-gray-700': item.recambio_realizado
                                    }"
                                    [title]="item.recambio_realizado ? 'No se puede eliminar una venta con recambio realizado' : 'Eliminar venta'">
                                <svg class="w-4 h-4 transition-transform group-hover/btn:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m2 0a2 2 0 00-2-2H9a2 2 0 00-2 2h10z"></path>
                                </svg>
                                <span class="hidden sm:inline ml-1.5">Eliminar</span>
                            </button>
                        </div>
  
                        <div class="flex gap-2 mt-3" *ngIf="item.tipo === 'venta'">
                            <button *appPermiso="['historial', 'ver']"
                                    (click)="abrirModalRecibo(item); $event.stopPropagation()"
                                    class="px-3 py-1.5 text-sm rounded-lg transition-colors flex items-center gap-1"
                                    [ngClass]="themeService.theme() === 'dark' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'">
                                <span>Recibo</span>
                            </button>
                            <button *appPermiso="['historial', 'ver']"
        (click)="abrirModalEmail(item); $event.stopPropagation()"
        class="px-3 py-1.5 text-sm rounded-lg transition-colors flex items-center gap-1"
        [ngClass]="themeService.theme() === 'dark' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'">
  <span>Enviar detalle</span>
</button>

                            <button
    *ngIf="!item.facturada"
    (click)="solicitarFacturacion(item); $event.stopPropagation()"
    class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors bg-blue-600 hover:bg-blue-700 text-white">
    <span class="flex items-center gap-1">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      Facturar
      <!-- Indicador de cliente asociado -->
@if (item['cliente_id']) {
  <span class="ml-1 px-1.5 py-0.5 rounded text-xs bg-green-500/20 text-green-300 border border-green-500/30">
    Con cliente
  </span>
}
      
    </span>
  </button>

  <!-- Indicador si ya est√° facturada -->
  <div *ngIf="item.facturada" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
    <span class="flex items-center gap-1">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Factura {{ item.factura_tipo }}
      @if (item.factura_nro) {
        <span class="ml-1 font-mono text-xs">{{ item.factura_nro }}</span>
      }
    </span>
  </div>

    <a *ngIf="item.facturada" 
       [href]="item.factura_pdf_url" 
       target="_blank" 
       (click)="$event.stopPropagation()"
       class="px-3 py-1.5 text-sm rounded-lg transition-colors flex items-center gap-1 bg-green-600 hover:bg-green-700 text-white">
       Ver Factura
    </a>
                        </div>
                    </div>
                </div>
  
                <div *ngIf="item.tipo === 'recambio'">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <span [ngClass]="themeService.theme() === 'dark' ? 'bg-orange-900/30 text-orange-400' : 'bg-orange-100 text-orange-800'"
                                  class="inline-block px-3 py-1 rounded-full text-xs font-semibold">
                                RECAMBIO
                            </span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-500'"
                                  class="text-sm">ID: {{ item.id.slice(-8) || 'N/A' }}</span>
                            <svg class="w-5 h-5 transition-transform duration-300"
                                 [class.rotate-180]="isCardExpandido(item.id)"
                                 [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-500'"
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
  
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-1 mb-2 text-sm">
                        <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-600'">
                            <strong>Cliente:</strong> {{ item.cliente_nombre || 'Sin cliente' }}
                        </p>
                        <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-600'">
                            <strong>Fecha:</strong> {{ item.fecha | date: 'dd/MM/yyyy HH:mm' }}
                        </p>
                    </div>
  
                    <p [ngClass]="themeService.theme() === 'dark' ? 'text-orange-400' : 'text-orange-600'"
                       class="text-lg font-bold">
                        Diferencia: {{ ((item.total_recambio || 0) - (item.total_devuelto || 0)) | monedaArs }}
                    </p>
  
                    <div *ngIf="isCardExpandido(item.id)" 
                         class="mt-4 pt-4 border-t animate-fade-in"
                         [ngClass]="themeService.theme() === 'dark' ? 'border-gray-700' : 'border-gray-200'"
                         (click)="$event.stopPropagation()">
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-1 mb-4 text-sm">
                            <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-700'"
                               class="font-medium"><strong>Realizado por:</strong> {{ item.realizado_por || 'Sin especificar' }}</p>
                            <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-600'">
                                <strong>ID Venta original:</strong> {{ item.venta_id?.slice(-8) || 'N/A' }}</p>
                        </div>
  
                        <div [ngClass]="themeService.theme() === 'dark' ? 'border-gray-700' : 'border-gray-200'"
                             class="mt-4 border-t pt-4 space-y-4">
                            <div>
                                <p [ngClass]="themeService.theme() === 'dark' ? 'text-red-400' : 'text-red-700'"
                                   class="font-semibold mb-2 text-sm">Productos devueltos:</p>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li *ngFor="let p of item.productos_devueltos || []; trackBy: trackByProductoId" 
                                        [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-700'">
                                        {{ p.nombre }} ‚Äî 
                                        <span class="font-medium">Marca: {{ p.marca || 'N/A' }}</span> ‚Äî 
                                        Talle: {{ p.talle || 'N/A' }} ‚Äî 
                                        Cant: {{ p.cantidad }} ‚Äî 
                                        {{ (p.precio_unitario || 0) | monedaArs }} c/u ‚Äî 
                                        Subtotal: <span class="font-medium">{{ (p.subtotal || 0) | monedaArs }}</span>
                                    </li>
                                </ul>
                            </div>
                            <div>
                                <p [ngClass]="themeService.theme() === 'dark' ? 'text-green-400' : 'text-green-700'"
                                   class="font-semibold mb-2 text-sm">Productos de recambio:</p>
                                <ul class="list-disc ml-5 space-y-1 text-sm">
                                    <li *ngFor="let p of item.productos_recambio || []; trackBy: trackByProductoId" 
                                        [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-700'">
                                        {{ p.nombre }} ‚Äî 
                                        <span class="font-medium">Marca: {{ p.marca || 'N/A' }}</span> ‚Äî 
                                        Talle: {{ p.talle || 'N/A' }} ‚Äî 
                                        Cant: {{ p.cantidad }} ‚Äî 
                                        {{ (p.precio_unitario || 0) | monedaArs }} c/u ‚Äî 
                                        Subtotal: <span class="font-medium">{{ (p.subtotal || 0) | monedaArs }}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div [ngClass]="themeService.theme() === 'dark' ? 'border-gray-700' : 'border-gray-200'"
                             class="mt-4 border-t pt-4 space-y-2">
                            <p *ngIf="(item.diferencia_abonada || 0) > 0">
                                <strong>Diferencia abonada: </strong> <span class="font-medium">{{ (item.diferencia_abonada || 0) | monedaArs }}</span>
                                <span class="text-sm ml-2">({{ getMetodoLabel(item.metodo_pago_diferencia || '') || 'No especificado' }})</span>
                            </p>
                            <div *ngIf="item.motivo" 
                                 [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700/50' : 'bg-gray-50'"
                                 class="mt-3 rounded-lg p-3 text-sm">
                                <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-700'"
                                   class="font-semibold mb-1">Motivo del recambio:</p>
                                <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-600'">{{ item.motivo }}</p>
                            </div>
                            <div *ngIf="item.observaciones" 
                                 [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700/50' : 'bg-gray-50'"
                                 class="mt-3 rounded-lg p-3 text-sm">
                                <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-700'"
                                   class="font-semibold mb-1">Observaciones:</p>
                                <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-600'">{{ item.observaciones }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div *ngIf="cargandoMas()" class="flex justify-center py-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2"
                 [ngClass]="themeService.theme() === 'dark' ? 'border-blue-400' : 'border-blue-600'"></div>
        </div>

        <div *ngIf="!hayMasDatos() && items().length > 0" 
             class="text-center py-4"
             [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-500'">
            <p class="text-sm">No hay m√°s registros para mostrar</p>
        </div>
    </div>

    <div *ngIf="!cargando() && items().length === 0" 
     [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-800' : 'bg-white'"
     class="text-center py-12 rounded-xl shadow-lg">
    <div class="text-gray-400 text-6xl mb-4">üìã</div>
    <h3 [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-600'"
        class="text-xl font-semibold mb-2">No hay registros</h3>
    <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-500'">
        No se encontraron {{ tipoFiltro() === 'todos' ? 'transacciones' : tipoFiltro() }} para el per√≠odo seleccionado.
    </p>
</div>

    <div *ngIf="mostrarModalRecambio()" 
         class="fixed inset-0 bg-black/10 backdrop-blur-sm flex items-center justify-center p-4 z-50">
      <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-800' : 'bg-white'"
           class="rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all duration-300">
        
        <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'"
             class="sticky top-0 border-b px-6 py-4 flex justify-between items-center">
          <h3 [ngClass]="themeService.theme() === 'dark' ? 'text-gray-100' : 'text-gray-900'"
              class="text-xl font-bold">Realizar Recambio</h3>
          <button (click)="cerrarModalRecambio()" 
                  [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400 hover:text-gray-200' : 'text-gray-400 hover:text-gray-700'"
                  class="text-3xl font-light leading-none transition">&times;</button>
        </div>

        <div class="p-6">
          <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700/50 border-blue-500' : 'bg-gray-100 border-blue-500'"
               class="rounded-xl p-4 mb-6 border-l-4">
            <h4 [ngClass]="themeService.theme() === 'dark' ? 'text-gray-100' : 'text-gray-800'"
                class="font-bold mb-2">Venta Original</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-1 text-sm">
              <p><strong>Cliente:</strong> {{ ventaSeleccionada()?.cliente_nombre || 'Sin cliente' }}</p>
              <p><strong>Fecha:</strong> {{ ventaSeleccionada()?.fecha | date: 'dd/MM/yyyy HH:mm' }}</p>
              <p><strong>Total original:</strong> <span class="font-medium">{{ (ventaSeleccionada()?.total_final || 0) | monedaArs }}</span></p>
              <p *ngIf="(ventaSeleccionada()?.descuento_aplicado || 0) > 0">
                <strong>Descuento original:</strong> {{ ventaSeleccionada()?.descuento_aplicado }}%
              </p>
            </div>
          </div>

          <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-750 border-red-500' : 'bg-white border-red-500'"
               class="rounded-xl shadow-md p-6 mb-8 border-l-4">
            <h4 [ngClass]="themeService.theme() === 'dark' ? 'text-red-400' : 'text-red-700'"
                class="font-bold text-lg mb-4">1. Productos a devolver</h4>
            <div class="space-y-4">
              <div *ngFor="let producto of productosOriginales(); let i = index" 
                   [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-50 hover:bg-gray-100'"
                   class="rounded-lg p-4 transition-all duration-200">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-2 sm:space-y-0">
                  <label [for]="'producto-' + i" class="flex items-center space-x-3 flex-1 cursor-pointer">
                    <input 
                      type="checkbox" 
                      [id]="'producto-' + i"
                      [(ngModel)]="producto.seleccionado"
                      (change)="calcularTotalesRecambio()"
                      class="w-5 h-5 text-red-600 focus:ring-red-500 rounded flex-shrink-0">
                    <div>
                      <div [ngClass]="themeService.theme() === 'dark' ? 'text-gray-100' : 'text-gray-900'"
                           class="font-medium">{{ producto.nombre }}</div>
                      <div [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-600'"
                           class="text-sm">
                        Talle: {{ producto.talle }} | Precio: {{ (producto.precio_unitario || 0) | monedaArs }}
                      </div>
                    </div>
                  </label>
                  
                  <div class="flex items-center space-x-2 text-sm" *ngIf="producto.seleccionado">
                    <label class="font-medium">Cant:</label>
                    <select [(ngModel)]="producto.cantidadDevolver" (change)="calcularTotalesRecambio()" 
                            [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-600 border-gray-500 text-gray-100' : 'bg-white border-gray-300 text-gray-900'"
                            class="border rounded-lg px-2 py-1 w-16 focus:ring-2 focus:ring-red-500">
                      <option *ngFor="let c of getOpcionesCantidad(producto.cantidad)" [value]="c">{{ c }}</option>
                    </select>
                    <span [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-500'">
                      de {{ producto.cantidad || 0 }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-750 border-green-500' : 'bg-white border-green-500'"
               class="rounded-xl shadow-md p-6 mb-8 border-l-4">
            <h4 [ngClass]="themeService.theme() === 'dark' ? 'text-green-400' : 'text-green-700'"
                class="font-bold text-lg mb-4">2. Productos de recambio</h4>
            
            <div class="mb-4 relative">
  <input 
    type="text" 
    [ngModel]="busquedaProducto()"
    (ngModelChange)="busquedaProducto.set($event)"
    (input)="buscarProductos()"
    placeholder="Buscar productos por nombre, c√≥digo o marca..."
    [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700 border-gray-600 text-gray-100 placeholder-gray-400' : 'bg-white border-gray-300 text-gray-900'"
    class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent transition"
    [style.padding-right]="busquedaProducto() ? '3rem' : '1rem'"
  />
  
  <!-- Bot√≥n X para limpiar b√∫squeda -->
  <button
    *ngIf="busquedaProducto()"
    (click)="limpiarBusquedaProducto()"
    class="absolute right-3 top-1/2 transform -translate-y-1/2 p-2 rounded-lg transition-all duration-200 hover:bg-red-100 dark:hover:bg-red-900/30
           text-gray-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400"
    title="Limpiar b√∫squeda">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
  </button>
</div>

            <div [ngClass]="themeService.theme() === 'dark' ? 'border-gray-600' : 'border-gray-200'"
                 class="max-h-60 overflow-y-auto border rounded-lg mb-4">
              <div *ngFor="let producto of productosFiltrados()" 
                   [ngClass]="themeService.theme() === 'dark' ? 'border-gray-600 hover:bg-green-900/20' : 'border-gray-200 hover:bg-green-50'"
                   class="border-b last:border-b-0 p-3 transition-colors duration-200 cursor-pointer"
                   (click)="agregarProductoRecambio(producto)">
                <div class="flex items-center justify-between">
                  <div>
                    <div [ngClass]="themeService.theme() === 'dark' ? 'text-gray-100' : 'text-gray-900'"
                         class="font-medium">{{ producto.nombre }}</div>
                    <div [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-600'"
                         class="text-sm">
                      {{ producto.marca }} | Talle: {{ producto.talle }} | Stock: {{ producto.cantidad_stock }}
                    </div>
                  </div>
                  <div class="text-right flex-shrink-0">
                    <div [ngClass]="themeService.theme() === 'dark' ? 'text-green-400' : 'text-green-600'"
                         class="font-semibold">{{ (producto.precio || 0) | monedaArs }}</div>
                    <button class="bg-green-500 text-white px-3 py-1 rounded-full text-xs hover:bg-green-600 transition mt-1">
                      Agregar
                    </button>
                  </div>
                </div>
              </div>
              <div *ngIf="productosFiltrados().length === 0" 
                   [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-500'"
                   class="p-4 text-center text-sm">
                No se encontraron productos.
              </div>
            </div>

            <div *ngIf="productosRecambio().length > 0">
              <h5 [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-800'"
                  class="font-semibold mb-2">Productos seleccionados:</h5>
              <div class="space-y-2">
                <div *ngFor="let item of productosRecambio(); let i = index" 
                     [ngClass]="themeService.theme() === 'dark' ? 'bg-green-900/20 border-green-700' : 'bg-green-50 border-green-200'"
                     class="border rounded-lg p-3 flex justify-between items-center transition-all duration-200">
                  <div>
                    <div [ngClass]="themeService.theme() === 'dark' ? 'text-gray-100' : 'text-gray-800'"
                         class="font-medium">{{ item.producto.nombre }}</div>
                    <div [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-600'"
                         class="text-sm">
                      Talle: {{ item.producto.talle }} | {{ (item.producto.precio || 0) | monedaArs }} c/u
                    </div>
                  </div>
                  <div class="flex items-center space-x-2">
                    <input 
                      type="number" 
                      [(ngModel)]="item.cantidad"
                      (input)="calcularTotalesRecambio()"
                      min="1" 
                      [max]="item.producto.cantidad_stock"
                      [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700 border-gray-600 text-gray-100' : 'bg-white border-gray-300 text-gray-900'"
                      class="w-16 border rounded-lg px-2 py-1 text-center text-sm focus:ring-2 focus:ring-green-500">
                    <button (click)="quitarProductoRecambio(i)" 
                            [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400 hover:text-red-400' : 'text-gray-400 hover:text-red-500'"
                            class="transition">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-750 border-blue-500' : 'bg-white border-blue-500'"
               class="rounded-xl shadow-md p-6 mb-8 border-l-4">
            <h4 [ngClass]="themeService.theme() === 'dark' ? 'text-blue-400' : 'text-blue-700'"
                class="font-bold text-lg mb-4">3. Resumen y Confirmaci√≥n</h4>

            <div class="mb-6">
              <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-800'"
                 class="font-semibold mb-2">Descuento (opcional)</p>
              <div class="flex items-center space-x-3">
                <input 
                  type="text" 
                  [ngModel]="codigoDescuentoRecambio()"
                  (ngModelChange)="codigoDescuentoRecambio.set($event)"
                  placeholder="C√≥digo de descuento"
                  [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700 border-gray-600 text-gray-100 placeholder-gray-400' : 'bg-white border-gray-300 text-gray-900'"
                  class="border rounded-lg px-4 py-2 flex-1 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button 
                  (click)="aplicarDescuentoRecambio()"
                  class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors font-medium">
                  Aplicar
                </button>
              </div>
              
              <div class="mt-3 p-3 rounded-lg"
                   [ngClass]="themeService.theme() === 'dark' 
                     ? 'bg-blue-900/20 border border-blue-800/50' 
                     : 'bg-blue-50 border border-blue-200'">
                <div class="flex items-start space-x-2">
                  <svg class="w-5 h-5 flex-shrink-0 mt-0.5"
                       [ngClass]="themeService.theme() === 'dark' ? 'text-blue-400' : 'text-blue-600'"
                       fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div class="flex-1">
                    <p class="text-xs font-semibold"
                       [ngClass]="themeService.theme() === 'dark' ? 'text-blue-300' : 'text-blue-800'">
                      ‚ÑπÔ∏è Importante sobre descuentos en recambios:
                    </p>
                    <p class="text-xs mt-1"
                       [ngClass]="themeService.theme() === 'dark' ? 'text-blue-400' : 'text-blue-700'">
                      Solo se permiten descuentos por <strong>porcentaje</strong> (ej: 10%, 20%). Los descuentos por cantidad (2x1, 3x2, etc.) no est√°n disponibles para recambios.
                    </p>
                  </div>
                </div>
              </div>
              
              <div *ngIf="descuentoRecambioAplicado() > 0" 
                   [ngClass]="themeService.theme() === 'dark' ? 'text-green-400' : 'text-green-600'"
                   class="mt-2 text-sm flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                Descuento del {{ descuentoRecambioAplicado() }}% aplicado
              </div>
              
              <button *ngIf="descuentoRecambioAplicado() > 0"
                      (click)="quitarDescuentoRecambio()"
                      [ngClass]="themeService.theme() === 'dark' 
                        ? 'text-red-400 hover:text-red-300 bg-red-900/20 hover:bg-red-900/30' 
                        : 'text-red-600 hover:text-red-700 bg-red-50 hover:bg-red-100'"
                      class="mt-2 text-xs px-3 py-1.5 rounded-lg transition-colors flex items-center space-x-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                <span>Quitar descuento</span>
              </button>
            </div>

            <div [ngClass]="themeService.theme() === 'dark' ? 'bg-blue-900/20' : 'bg-blue-50'"
                 class="rounded-lg p-4 mb-6 text-sm">
              <p [ngClass]="themeService.theme() === 'dark' ? 'text-blue-300' : 'text-blue-800'"
                 class="font-semibold mb-3">Detalle</p>
              <div class="space-y-2">
                <div [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-700'"
                     class="flex justify-between">
                  <span>Total devuelto:</span>
                  <span [ngClass]="themeService.theme() === 'dark' ? 'text-red-400' : 'text-red-600'"
                        class="font-medium">- {{ totalDevuelto() | monedaArs }}</span>
                </div>
                <div [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-700'"
                     class="flex justify-between">
                  <span>Total recambio:</span>
                  <span [ngClass]="themeService.theme() === 'dark' ? 'text-green-400' : 'text-green-600'"
                        class="font-medium">+ {{ totalRecambio() | monedaArs }}</span>
                </div>
                <div *ngIf="montoDescuentoRecambio() > 0" 
                     [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-700'"
                     class="flex justify-between">
                  <span>Ahorro por descuento:</span>
                  <span [ngClass]="themeService.theme() === 'dark' ? 'text-purple-400' : 'text-purple-600'"
                        class="font-medium">- {{ montoDescuentoRecambio() | monedaArs }}</span>
                </div>
                <hr [ngClass]="themeService.theme() === 'dark' ? 'border-gray-600' : 'border-gray-300'"
                    class="my-2 border-dashed">
                <div [ngClass]="themeService.theme() === 'dark' ? 'text-gray-100' : 'text-gray-900'"
                     class="flex justify-between font-bold text-lg">
                  <span>Diferencia:</span>
                  <span [class.text-green-600]="diferencia() >= 0 && themeService.theme() !== 'dark'" 
                        [class.text-green-400]="diferencia() >= 0 && themeService.theme() === 'dark'"
                        [class.text-red-600]="diferencia() < 0 && themeService.theme() !== 'dark'"
                        [class.text-red-400]="diferencia() < 0 && themeService.theme() === 'dark'">
                    {{ diferencia() | monedaArs }}
                  </span>
                </div>
              </div>
            </div>

            <div *ngIf="diferencia() > 0" class="mb-6">
              <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-800'"
                 class="font-semibold mb-2">M√©todo de pago para la diferencia</p>
              <div class="flex flex-wrap gap-3">
                <label *ngFor="let metodo of metodosPago" 
                       [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'"
                       class="flex items-center space-x-2 cursor-pointer rounded-lg px-3 py-2 text-sm font-medium transition">
                  <input 
                    type="radio" 
                    name="metodoPago" 
                    [value]="metodo"
                    [ngModel]="metodoPagoSeleccionado()"
                    (ngModelChange)="metodoPagoSeleccionado.set($event)"
                    class="text-blue-600 focus:ring-blue-500">
                  <span>{{ getMetodoLabel(metodo) }}</span>
                </label>
              </div>
            </div>

            <div class="space-y-4">
              <div>
                <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-800'"
                   class="font-semibold mb-2">Motivo del recambio</p>
                <textarea 
                  [ngModel]="motivoRecambio()"
                  (ngModelChange)="motivoRecambio.set($event)"
                  placeholder="Describe el motivo del recambio..."
                  [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700 border-gray-600 text-gray-100 placeholder-gray-400' : 'bg-white border-gray-300 text-gray-900'"
                  class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                  rows="3"></textarea>
              </div>
              <div>
                <p [ngClass]="themeService.theme() === 'dark' ? 'text-gray-200' : 'text-gray-800'"
                   class="font-semibold mb-2">Observaciones adicionales (opcional)</p>
                <textarea 
                  [ngModel]="observacionesRecambio()"
                  (ngModelChange)="observacionesRecambio.set($event)"
                  placeholder="Detalles adicionales para el registro..."
                  [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700 border-gray-600 text-gray-100 placeholder-gray-400' : 'bg-white border-gray-300 text-gray-900'"
                  class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                  rows="2"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'"
             class="sticky bottom-0 border-t px-6 py-4 flex flex-col sm:flex-row-reverse justify-between items-center space-y-3 sm:space-y-0 sm:space-x-3">
          <button 
            (click)="procesarRecambio()"
            [disabled]="!puedeConfirmarRecambio()"
            class="w-full sm:w-auto px-6 py-3 rounded-full font-bold transition-all"
            [class.bg-green-600]="puedeConfirmarRecambio()"
            [class.hover:bg-green-700]="puedeConfirmarRecambio()"
            [class.text-white]="puedeConfirmarRecambio()"
            [class.bg-gray-200]="!puedeConfirmarRecambio() && themeService.theme() !== 'dark'"
            [class.bg-gray-700]="!puedeConfirmarRecambio() && themeService.theme() === 'dark'"
            [class.text-gray-500]="!puedeConfirmarRecambio() && themeService.theme() !== 'dark'"
            [class.text-gray-400]="!puedeConfirmarRecambio() && themeService.theme() === 'dark'">
            {{ procesandoRecambio() ? 'Procesando...' : 'Confirmar Recambio' }}
          </button>
          <button 
            (click)="cerrarModalRecambio()" 
            class="w-full sm:w-auto px-6 py-3 rounded-full font-medium bg-red-500 hover:bg-red-600 text-white transition-colors">
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="toastVisible()" class="fixed bottom-6 right-6 z-[10000] animate-slide-in-right">
      <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-800 border-gray-700 text-white' : 'bg-white border-gray-100 text-gray-800'"
           class="flex items-center gap-4 px-6 py-4 rounded-2xl shadow-2xl border">
        
        <div [ngClass]="{
          'bg-green-100 text-green-600': tipoMensajeToast() === 'success',
          'bg-red-100 text-red-600': tipoMensajeToast() === 'error',
          'bg-amber-100 text-amber-600': tipoMensajeToast() === 'warning'
        }" class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0">
          <svg *ngIf="tipoMensajeToast() === 'success'" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <svg *ngIf="tipoMensajeToast() === 'error'" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          <svg *ngIf="tipoMensajeToast() === 'warning'" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
        </div>

        <div>
          <h4 class="font-bold text-sm">
            {{ tipoMensajeToast() === 'success' ? '¬°√âxito!' : tipoMensajeToast() === 'warning' ? '¬°Atenci√≥n!' : 'Error' }}
          </h4>
          <p class="text-sm opacity-80">{{ toastMensaje() }}</p>
        </div>
      </div>
    </div>

    <div *ngIf="mostrarModalEmail()" 
         class="fixed inset-0 z-50 flex items-center justify-center p-4">
      
      <div class="absolute inset-0 bg-black/10 backdrop-blur-sm"
           (click)="cerrarModalEmail()"></div>

      <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-800' : 'bg-white'" 
           class="relative rounded-2xl shadow-2xl max-w-md w-full animate-fade-in-scale"
           (click)="$event.stopPropagation()">
        
        <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
              <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
              </svg>
            </div>

            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1">
              <h3 [ngClass]="themeService.theme() === 'dark' ? 'text-white' : 'text-gray-900'" 
                  class="text-lg sm:text-xl font-bold mb-2" 
                  id="modal-title">
                Enviar Detalle de Venta
              </h3>
              <div class="mt-2">
                <label class="block text-sm font-medium mb-2" 
                       [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-700'">
                  Email de destino
                </label>
                <input
                  type="email"
                  [ngModel]="emailDestino()"
                  (ngModelChange)="emailDestino.set($event)"
                  placeholder="cliente@ejemplo.com"
                  class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500"
                  [ngClass]="themeService.theme() === 'dark' 
                    ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' 
                    : 'bg-white border-gray-300 text-gray-900 placeholder-gray-500'"/>
              </div>
            </div>
          </div>
        </div>

        <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700/50' : 'bg-gray-50'" 
             class="px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
          
          <button
            type="button"
            (click)="enviarDetalleEmail()"
            [disabled]="enviandoEmail()"
            class="w-full inline-flex justify-center items-center gap-2 rounded-xl border border-transparent shadow-sm px-4 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-base font-medium text-white hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:w-auto sm:text-sm transition-all duration-200 disabled:opacity-50">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            {{ enviandoEmail() ? 'Enviando...' : 'Enviar Email' }}
          </button>
          
          <button
            type="button"
            (click)="cerrarModalEmail()"
            [ngClass]="themeService.theme() === 'dark' 
              ? 'bg-gray-600 text-gray-200 hover:bg-gray-500 border-gray-500' 
              : 'bg-white text-gray-700 hover:bg-gray-50 border-gray-300'"
            class="mt-3 w-full inline-flex justify-center rounded-xl border shadow-sm px-4 py-2.5 text-base font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm transition-all duration-200">
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="mostrarModalFormatoRecibo()" 
         class="fixed inset-0 z-50 flex items-center justify-center p-4">
      
      <div class="absolute inset-0 bg-black/10 backdrop-blur-sm"
           (click)="cerrarModalFormatoRecibo()"></div>

      <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-800' : 'bg-white'" 
           class="relative rounded-2xl shadow-2xl max-w-lg w-full animate-fade-in-scale"
           (click)="$event.stopPropagation()">
        
        <div class="px-6 pt-6 pb-4">
          <div class="flex items-center justify-between mb-6">
            <h3 [ngClass]="themeService.theme() === 'dark' ? 'text-white' : 'text-gray-900'" 
                class="text-xl font-bold">
              Selecciona el formato del recibo
            </h3>
            <button (click)="cerrarModalFormatoRecibo()"
                    class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">
              &times;
            </button>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <button
              (click)="seleccionarFormatoRecibo('termica')"
              class="group relative overflow-hidden rounded-xl border-2 transition-all duration-300 hover:scale-105"
              [ngClass]="themeService.theme() === 'dark' 
                ? 'border-gray-600 hover:border-blue-500 bg-gray-700' 
                : 'border-gray-200 hover:border-blue-500 bg-white'">
              <div class="p-6 text-center">
                <div class="mx-auto w-16 h-16 mb-4 rounded-full flex items-center justify-center"
                     [ngClass]="themeService.theme() === 'dark' ? 'bg-blue-900/30' : 'bg-blue-100'">
                  <svg class="w-8 h-8"
                       [ngClass]="themeService.theme() === 'dark' ? 'text-blue-400' : 'text-blue-600'"
                       fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
                <h4 class="font-bold text-lg mb-2"
                    [ngClass]="themeService.theme() === 'dark' ? 'text-gray-100' : 'text-gray-900'">
                  Impresora T√©rmica
                </h4>
                <p class="text-sm"
                   [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-600'">
                  Formato 80mm (ticket)
                </p>
              </div>
            </button>

            <button
              (click)="seleccionarFormatoRecibo('a4')"
              class="group relative overflow-hidden rounded-xl border-2 transition-all duration-300 hover:scale-105"
              [ngClass]="themeService.theme() === 'dark' 
                ? 'border-gray-600 hover:border-green-500 bg-gray-700' 
                : 'border-gray-200 hover:border-green-500 bg-white'">
              <div class="p-6 text-center">
                <div class="mx-auto w-16 h-16 mb-4 rounded-full flex items-center justify-center"
                     [ngClass]="themeService.theme() === 'dark' ? 'bg-green-900/30' : 'bg-green-100'">
                  <svg class="w-8 h-8"
                       [ngClass]="themeService.theme() === 'dark' ? 'text-green-400' : 'text-green-600'"
                       fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                  </svg>
                </div>
                <h4 class="font-bold text-lg mb-2"
                    [ngClass]="themeService.theme() === 'dark' ? 'text-gray-100' : 'text-gray-900'">
                  Formato A4
                </h4>
                <p class="text-sm"
                   [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-600'">
                  Hoja completa est√°ndar
                </p>
              </div>
            </button>
          </div>

          <div *ngIf="ventaParaGenerarRecibo()" 
               class="mt-6 p-4 rounded-lg"
               [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700/50' : 'bg-gray-50'">
            <p class="text-sm font-medium mb-2"
               [ngClass]="themeService.theme() === 'dark' ? 'text-gray-300' : 'text-gray-700'">
              Detalle de la venta:
            </p>
            <div class="space-y-1 text-sm"
                 [ngClass]="themeService.theme() === 'dark' ? 'text-gray-400' : 'text-gray-600'">
              <p><span class="font-medium">Cliente:</span> {{ ventaParaGenerarRecibo().cliente_nombre || 'Sin cliente' }}</p>
              <p><span class="font-medium">Total:</span> {{ ventaParaGenerarRecibo().total_final | monedaArs }}</p>
              <p><span class="font-medium">Fecha:</span> {{ ventaParaGenerarRecibo().fecha | date:'dd/MM/yyyy HH:mm' }}</p>
            </div>
          </div>
        </div>

        <div [ngClass]="themeService.theme() === 'dark' ? 'bg-gray-700/50' : 'bg-gray-50'" 
             class="px-6 py-4 rounded-b-2xl">
          <button
            (click)="cerrarModalFormatoRecibo()"
            class="w-full px-4 py-2 rounded-lg font-medium transition-colors"
            [ngClass]="themeService.theme() === 'dark' 
              ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' 
              : 'bg-gray-200 text-gray-700 hover:bg-gray-300'">
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="mostrandoConfirmacionEliminar()" 
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/10 backdrop-blur-sm">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6 animate-fade-in-scale">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Confirmar Eliminaci√≥n</h3>
        
        <div class="mb-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
          <p class="text-red-700 dark:text-red-300 text-sm">
            <strong>¬°Atenci√≥n!</strong> Est√°s a punto de eliminar una venta. Esta acci√≥n:
          </p>
          <ul class="list-disc ml-5 mt-2 text-sm text-red-600 dark:text-red-400">
            <li>Restaurar√° el stock de los productos.</li>
            <li *ngIf="ventaAEliminar()?.metodo_pago === 'fiado'">Ajustar√° el saldo de la cuenta corriente del cliente.</li>
            <li>Eliminar√° el registro de la venta permanentemente.</li>
            <li>Guardar√° un registro en el historial de eliminaciones.</li>
          </ul>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Motivo de la eliminaci√≥n <span class="text-red-500">*</span>
          </label>
          <textarea 
            [ngModel]="motivoEliminacion()"
            (ngModelChange)="motivoEliminacion.set($event)"
            rows="3"
            class="w-full px-3 py-2 border rounded-md focus:ring-red-500 focus:border-red-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
            placeholder="Ej: Error en el cobro, devoluci√≥n completa, etc."
          ></textarea>
        </div>

        <div class="flex justify-end gap-3">
          <button 
            (click)="cancelarEliminacion()"
            class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-colors"
            [disabled]="eliminandoVenta()">
            Cancelar
          </button>
          <button 
            (click)="confirmarEliminacion()"
            class="px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-md flex items-center gap-2 transition-colors"
            [disabled]="!motivoEliminacion().trim() || eliminandoVenta()">
            <svg *ngIf="eliminandoVenta()" class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            {{ eliminandoVenta() ? 'Eliminando...' : 'Eliminar Venta' }}
          </button>
        </div>
      </div>
    </div>

  </div>

<!-- Modal de selecci√≥n de tipo de factura (solo para RI ‚Üí Monotributista) -->
<!-- Modal de selecci√≥n de tipo de factura -->
<div *ngIf="mostrarModalSeleccionFactura()" 
     class="fixed inset-0 z-[60] flex items-center justify-center p-4">
  
  <div class="absolute inset-0 bg-black/60 backdrop-blur-md"
       (click)="cerrarModalFacturacion()"></div>
  
  <div class="relative rounded-2xl shadow-2xl w-[95%] sm:w-full max-w-md max-h-[90vh] overflow-y-auto animate-fade-in-scale bg-white dark:bg-gray-800"
       (click)="$event.stopPropagation()">
    
    <div class="p-4 sm:p-6 border-b dark:border-gray-700">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">
            Seleccionar Tipo de Factura
          </h3>
          <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mt-1">
            <ng-container *ngIf="ventaParaFacturar()?.cliente_info?.condicion_iva === 'Consumidor Final'">
              Sin cliente registrado
            </ng-container>
            <ng-container *ngIf="ventaParaFacturar()?.cliente_info?.condicion_iva !== 'Consumidor Final'">
              Cliente {{ ventaParaFacturar()?.cliente_info?.condicion_iva }}
            </ng-container>
          </p>
        </div>
        <button 
          (click)="cerrarModalFacturacion()"
          class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors p-1">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Informaci√≥n del Cliente -->
    <div *ngIf="ventaParaFacturar()?.cliente_info" 
         class="mx-4 sm:mx-6 mt-4 sm:mt-6 p-3 rounded-xl border"
         [ngClass]="{
           'bg-blue-50 border-blue-200 dark:bg-blue-900/20 dark:border-blue-800': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Consumidor Final' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Exento',
           'bg-purple-50 border-purple-200 dark:bg-purple-900/20 dark:border-purple-800': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Responsable Inscripto',
           'bg-orange-50 border-orange-200 dark:bg-orange-900/20 dark:border-orange-800': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributista' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributo'
         }">
      <div class="flex items-start gap-3">
        <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center flex-shrink-0"
             [ngClass]="{
               'bg-blue-100 dark:bg-blue-900/40': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Consumidor Final' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Exento',
               'bg-purple-100 dark:bg-purple-900/40': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Responsable Inscripto',
               'bg-orange-100 dark:bg-orange-900/40': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributista' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributo'
             }">
          <svg class="w-4 h-4 sm:w-5 sm:h-5"
               [ngClass]="{
                 'text-blue-600 dark:text-blue-400': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Consumidor Final' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Exento',
                 'text-purple-600 dark:text-purple-400': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Responsable Inscripto',
                 'text-orange-600 dark:text-orange-400': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributista' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributo'
               }"
               fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-bold text-sm sm:text-base truncate"
             [ngClass]="{
               'text-blue-900 dark:text-blue-100': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Consumidor Final' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Exento',
               'text-purple-900 dark:text-purple-100': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Responsable Inscripto',
               'text-orange-900 dark:text-orange-100': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributista' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributo'
             }">
            {{ ventaParaFacturar()?.cliente_info?.nombre }}
          </p>
          <div class="flex flex-wrap gap-2 mt-1 text-[10px] sm:text-xs">
            <span class="px-2 py-0.5 rounded font-medium"
                  [ngClass]="{
                    'bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Consumidor Final' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Exento',
                    'bg-purple-100 text-purple-800 dark:bg-purple-900/40 dark:text-purple-300': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Responsable Inscripto',
                    'bg-orange-100 text-orange-800 dark:bg-orange-900/40 dark:text-orange-300': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributista' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributo'
                  }">
              {{ ventaParaFacturar()?.cliente_info?.condicion_iva }}
            </span>
            <span class="whitespace-nowrap"
                  [ngClass]="{
                    'text-blue-700 dark:text-blue-300': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Consumidor Final' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Exento',
                    'text-purple-700 dark:text-purple-300': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Responsable Inscripto',
                    'text-orange-700 dark:text-orange-300': ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributista' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributo'
                  }"
                  *ngIf="ventaParaFacturar()?.cliente_info?.cuit">
              CUIT: {{ ventaParaFacturar()?.cliente_info?.cuit }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Opciones de Factura -->
    <div class="p-4 sm:p-6">
      <div class="space-y-3">
        
        <!-- Factura A -->
        <button
          (click)="confirmarFacturacion('A')"
          class="w-full p-3 sm:p-4 rounded-xl border-2 transition-all duration-200 text-left border-purple-300 hover:border-purple-500 bg-purple-50 hover:bg-purple-100 dark:border-purple-700 dark:bg-purple-900/20 dark:hover:bg-purple-900/30">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center flex-shrink-0 bg-purple-100 dark:bg-purple-900/40">
              <span class="text-xl sm:text-2xl font-bold text-purple-700 dark:text-purple-400">A</span>
            </div>
            <div class="flex-1">
              <h4 class="font-bold text-base sm:text-lg text-gray-900 dark:text-white mb-0.5">
                Factura A
                <span *ngIf="ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributista' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributo'" 
                      class="text-xs font-normal opacity-75">(con leyenda especial)</span>
              </h4>
              <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mb-2 leading-tight">
                Discrimina IVA. 
                <ng-container *ngIf="ventaParaFacturar()?.cliente_info?.condicion_iva === 'Responsable Inscripto'">
                  <strong class="text-purple-700 dark:text-purple-400">Recomendado para Responsables Inscriptos.</strong>
                </ng-container>
                <ng-container *ngIf="ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributista' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributo'">
                  Incluye cr√©dito fiscal limitado.
                </ng-container>
              </p>
              
              <!-- Leyenda especial solo para Monotributistas -->
              <div *ngIf="ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributista' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributo'"
                   class="mt-1 p-1.5 rounded bg-orange-100 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800">
                <p class="text-[10px] sm:text-xs text-orange-800 dark:text-orange-300 italic leading-snug">
                  "El cr√©dito fiscal discriminado... solo podr√° ser computado a efectos del R√©gimen..."
                </p>
              </div>
              
              <!-- Badge de recomendado para RI -->
              <div *ngIf="ventaParaFacturar()?.cliente_info?.condicion_iva === 'Responsable Inscripto'"
                   class="mt-2 flex items-center gap-1.5 text-xs text-purple-700 dark:text-purple-400 font-medium">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>Recomendado</span>
              </div>
            </div>
          </div>
        </button>

        <!-- Factura B -->
        <button
          (click)="confirmarFacturacion('B')"
          class="w-full p-3 sm:p-4 rounded-xl border-2 transition-all duration-200 text-left border-blue-300 hover:border-blue-500 bg-blue-50 hover:bg-blue-100 dark:border-blue-700 dark:bg-blue-900/20 dark:hover:bg-blue-900/30">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center flex-shrink-0 bg-blue-100 dark:bg-blue-900/40">
              <span class="text-xl sm:text-2xl font-bold text-blue-700 dark:text-blue-400">B</span>
            </div>
            <div class="flex-1">
              <h4 class="font-bold text-base sm:text-lg text-gray-900 dark:text-white mb-0.5">
                Factura B
              </h4>
              <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 leading-tight">
                IVA incluido. 
                <ng-container *ngIf="ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributista' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributo'">
                  <strong class="text-blue-700 dark:text-blue-400">Opci√≥n est√°ndar para Monotributistas.</strong>
                </ng-container>
                <ng-container *ngIf="ventaParaFacturar()?.cliente_info?.condicion_iva === 'Consumidor Final' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Exento'">
                  <strong class="text-blue-700 dark:text-blue-400">Ideal para Consumidor Final.</strong>
                </ng-container>
                <ng-container *ngIf="ventaParaFacturar()?.cliente_info?.condicion_iva === 'Responsable Inscripto'">
                  Opci√≥n alternativa sin discriminaci√≥n de IVA.
                </ng-container>
              </p>
              
              <!-- Badge de recomendado para Monotributista/Consumidor Final -->
              <div *ngIf="ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributista' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Monotributo' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Consumidor Final' || ventaParaFacturar()?.cliente_info?.condicion_iva === 'Exento'"
                   class="mt-2 flex items-center gap-1.5 text-xs text-blue-700 dark:text-blue-400 font-medium">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 00118 0z"/>
                </svg>
                <span>Recomendado</span>
              </div>
            </div>
          </div>
        </button>
      </div>
    </div>

    <div class="px-4 py-3 sm:px-6 sm:py-4 border-t flex justify-end gap-3 bg-gray-50 dark:bg-gray-700/50 dark:border-gray-700 sticky bottom-0">
      <button
        (click)="cerrarModalFacturacion()"
        class="px-4 py-2 sm:px-6 sm:py-2.5 rounded-xl border-2 font-medium text-sm sm:text-base transition-colors border-gray-300 text-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">
        Cancelar
      </button>
    </div>
  </div>
</div>
</div>